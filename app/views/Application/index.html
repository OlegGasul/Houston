#{extends 'main.html' /}
#{set title: 'Houston HQ' /}

<div id="bar-wrp">
    <div>
        <input id="search_string" type="text" />
        <div id="results"></div>
    </div>
</div>

<div id="map-wrp">
    <div id="map"></div>
</div>

<div id="popup" style="display: none">
    <a href="#">Ехать сюда!</a>
</div>

<script>
    var searchController = new MapSearchController();
    var dataManager = new DataManager();
    var gpsMarker = null;
    var marker = null;
    var polyline;

    $(document).ready(function() {
        var map = new L.Map('map', {center: new L.LatLng(50.35472, 30.17350), zoom: 10, zoomAnimation: false });
        var yandex = new L.Yandex();
//        var yandexTraffic = new L.Yandex("null", {traffic: true, opacity: 0.8, overlay: true});
        map.addLayer(yandex);
        map.addControl(new L.Control.Layers({"Yandex": yandex}/*, {"Traffic": yandexTraffic}*/));

        function setMarker(latlng) {
            if (marker == null) {
                marker = L.marker(latlng, {draggable: 'true'}).addTo(map);
                marker.bindPopup($('#popup').html());
            } else
                marker.setLatLng(latlng);
        }

        $('#search_string').enterKey(function () {
            searchController.search('Киев, ' + $(this).val(), function(data) {
                $('#results').html('');
                for (var i = 0; i < data.length; i++) {
                    $('#results').append('<div><a href="#" class="address" data-coordinate="' + data[i].geo + '">' + data[i].description + '</a></div>')
                }

                $('.address').click(function() {
                    var coordinates = $(this).attr('data-coordinate').split(' ');
                    setMarker(coordinates.reverse());
                    map.setView(marker.getLatLng(), 17);
                });
            });
        });

        map.on('click', function(e) {
            setMarker(e.latlng);
        });

        function requestGPS() {
            dataManager.getKey("gps", 0, function(data) {
                if (data.value) {
                    var coordinates = data.value.split(',');
                    if (!gpsMarker) {
                        gpsMarker = L.marker(coordinates).addTo(map);
                    } else
                        gpsMarker.setLatLng(coordinates);
                }

                setTimeout(requestGPS, 1000);
            });
        }

        setTimeout(requestGPS, 1000);

        new L.Polyline([
                    30.54223,
                    50.44468
                ],
                [
                    30.54174,
                    50.44434
                ],
                [
                    30.54166,
                    50.44428
                ],
                [
                    30.54015,
                    50.44509
                ],
                [
                    30.53975,
                    50.44531
                ],
                [
                    30.53967,
                    50.44535
                ],
                [
                    30.53878,
                    50.44584
                ],
                [
                    30.53797,
                    50.44628
                ],
                [
                    30.53734,
                    50.44663
                ], {
            color: 'red',
            weight: 3,
            opacity: 0.5,
            smoothFactor: 1
        }).addTo(map);
    })
</script>